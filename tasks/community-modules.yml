---
- name: Copy requirements.txt
  copy: # 'noqa' below disables [E404] Donâ€™t compare to empty string
    src: "{{ inventory_dir }}/../files/requirements.txt" # noqa 404
    dest: "{{ odoo_role_odoo_modules_path }}/requirements.txt"
    owner: "{{ odoo_role_odoo_user }}"
    group: "{{ odoo_role_odoo_group }}"

- name: Deploy community roles with pip
  pip:
    requirements: "{{ odoo_role_odoo_modules_path }}/requirements.txt"
    virtualenv: "{{ odoo_role_odoo_venv_path }}"
  register: reg_pip
  become: yes
  become_user: "{{ odoo_role_odoo_user }}"

- name: Detect upgraded packages
  shell: >
    grep 'Successfully installed' |
    sed -r 's/ /\n/g' |
    egrep '^odoo1[0-9]-addon-[^ ]+-[0-9\.]+' |
    sed -r 's/odoo1[0-9]-addon-([^ ]+)-[0-9\.]+/\1/g' |
    tr -- '-' '_'

  args:
    stdin: "{{ reg_pip.stdout }}"
    executable: bash
  register: reg_pip_upgraded
  changed_when: reg_pip_upgraded.stdout
  failed_when: false # noqa 306 "shell and pipefail". Both grep and sed must be able to fail
